import fs from "fs-extra";
import { join } from "./path.js";
import chalk from "chalk";
import process from "process";
import findWorkspaceRoot from "find-yarn-workspace-root";
function printNoYarnLockfileError() {
    console.log(`
${chalk.red.bold("**ERROR**")} ${chalk.red(`The --use-yarn option was specified but there is no yarn.lock file`)}
`);
}
function printNoBunLockfileError() {
    console.log(`
${chalk.red.bold("**ERROR**")} ${chalk.red(`The --use-bun option was specified but there is no bun.lockb file`)}
`);
}
function printNoLockfilesError() {
    console.log(`
${chalk.red.bold("**ERROR**")} ${chalk.red(`No package-lock.json, npm-shrinkwrap.json, yarn.lock, or bun.lockb file.

You must use either npm@>=5, yarn, npm-shrinkwrap, or bun to manage this project's
dependencies.`)}
`);
}
function printSelectingDefaultMessage() {
    console.info(`${chalk.bold("patch-package")}: you have multiple lockfiles, e.g. yarn.lock and package-lock.json
Defaulting to using ${chalk.bold("npm")}
You can override this setting by passing --use-yarn, --use-bun, or
deleting the conflicting lockfile if you don't need it
`);
}
function printSelectingDefaultYarnMessage() {
    console.info(`${chalk.bold("patch-package")}: you have both yarn.lock and bun.lockb lockfiles
Defaulting to using ${chalk.bold("yarn")}
You can override this setting by passing --use-bun, or
deleting yarn.lock if you don't need it
`);
}
function checkForYarnOverride(overridePackageManager) {
    if (overridePackageManager === "yarn") {
        printNoYarnLockfileError();
        process.exit(1);
    }
}
function checkForBunOverride(overridePackageManager) {
    if (overridePackageManager === "bun") {
        printNoBunLockfileError();
        process.exit(1);
    }
}
export const detectPackageManager = (appRootPath, overridePackageManager) => {
    var _a, _b;
    const packageLockExists = fs.existsSync(join(appRootPath, "package-lock.json"));
    const shrinkWrapExists = fs.existsSync(join(appRootPath, "npm-shrinkwrap.json"));
    const yarnLockExists = fs.existsSync(join((_a = findWorkspaceRoot()) !== null && _a !== void 0 ? _a : appRootPath, "yarn.lock"));
    // Bun workspaces seem to work the same as yarn workspaces - https://bun.sh/docs/install/workspaces
    const bunLockbExists = fs.existsSync(join((_b = findWorkspaceRoot()) !== null && _b !== void 0 ? _b : appRootPath, "bun.lockb"));
    if ([
        packageLockExists || shrinkWrapExists,
        yarnLockExists,
        bunLockbExists,
    ].filter(Boolean).length > 1) {
        if (overridePackageManager) {
            return overridePackageManager;
        }
        if (!packageLockExists && !shrinkWrapExists) {
            // The only case where we don't want to default to npm is when we have both yarn and bun lockfiles.
            printSelectingDefaultYarnMessage();
            return "yarn";
        }
        printSelectingDefaultMessage();
        return shrinkWrapExists ? "npm-shrinkwrap" : "npm";
    }
    else if (packageLockExists || shrinkWrapExists) {
        checkForYarnOverride(overridePackageManager);
        checkForBunOverride(overridePackageManager);
        return shrinkWrapExists ? "npm-shrinkwrap" : "npm";
    }
    else if (yarnLockExists) {
        checkForBunOverride(overridePackageManager);
        return "yarn";
    }
    else if (bunLockbExists) {
        checkForYarnOverride(overridePackageManager);
        return "bun";
    }
    else {
        printNoLockfilesError();
        process.exit(1);
    }
    throw Error();
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV0ZWN0UGFja2FnZU1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZGV0ZWN0UGFja2FnZU1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sVUFBVSxDQUFBO0FBQ3pCLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUE7QUFDaEMsT0FBTyxLQUFLLE1BQU0sT0FBTyxDQUFBO0FBQ3pCLE9BQU8sT0FBTyxNQUFNLFNBQVMsQ0FBQTtBQUM3QixPQUFPLGlCQUFpQixNQUFNLDBCQUEwQixDQUFBO0FBSXhELFNBQVMsd0JBQXdCO0lBQy9CLE9BQU8sQ0FBQyxHQUFHLENBQUM7RUFDWixLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxLQUFLLENBQUMsR0FBRyxDQUN0QyxvRUFBb0UsQ0FDckU7Q0FDRixDQUFDLENBQUE7QUFDRixDQUFDO0FBRUQsU0FBUyx1QkFBdUI7SUFDOUIsT0FBTyxDQUFDLEdBQUcsQ0FBQztFQUNaLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQ3RDLG1FQUFtRSxDQUNwRTtDQUNGLENBQUMsQ0FBQTtBQUNGLENBQUM7QUFFRCxTQUFTLHFCQUFxQjtJQUM1QixPQUFPLENBQUMsR0FBRyxDQUFDO0VBQ1osS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FDdEM7OztjQUdVLENBQ1g7Q0FDRixDQUFDLENBQUE7QUFDRixDQUFDO0FBRUQsU0FBUyw0QkFBNEI7SUFDbkMsT0FBTyxDQUFDLElBQUksQ0FDVixHQUFHLEtBQUssQ0FBQyxJQUFJLENBQ1gsZUFBZSxDQUNoQjtzQkFDaUIsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUM7OztDQUd0QyxDQUNFLENBQUE7QUFDSCxDQUFDO0FBRUQsU0FBUyxnQ0FBZ0M7SUFDdkMsT0FBTyxDQUFDLElBQUksQ0FDVixHQUFHLEtBQUssQ0FBQyxJQUFJLENBQ1gsZUFBZSxDQUNoQjtzQkFDaUIsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7OztDQUd2QyxDQUNFLENBQUE7QUFDSCxDQUFDO0FBRUQsU0FBUyxvQkFBb0IsQ0FBQyxzQkFBNkM7SUFDekUsSUFBSSxzQkFBc0IsS0FBSyxNQUFNLEVBQUUsQ0FBQztRQUN0Qyx3QkFBd0IsRUFBRSxDQUFBO1FBQzFCLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDakIsQ0FBQztBQUNILENBQUM7QUFFRCxTQUFTLG1CQUFtQixDQUFDLHNCQUE2QztJQUN4RSxJQUFJLHNCQUFzQixLQUFLLEtBQUssRUFBRSxDQUFDO1FBQ3JDLHVCQUF1QixFQUFFLENBQUE7UUFDekIsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUNqQixDQUFDO0FBQ0gsQ0FBQztBQUVELE1BQU0sQ0FBQyxNQUFNLG9CQUFvQixHQUFHLENBQ2xDLFdBQW1CLEVBQ25CLHNCQUE2QyxFQUM3QixFQUFFOztJQUNsQixNQUFNLGlCQUFpQixHQUFHLEVBQUUsQ0FBQyxVQUFVLENBQ3JDLElBQUksQ0FBQyxXQUFXLEVBQUUsbUJBQW1CLENBQUMsQ0FDdkMsQ0FBQTtJQUNELE1BQU0sZ0JBQWdCLEdBQUcsRUFBRSxDQUFDLFVBQVUsQ0FDcEMsSUFBSSxDQUFDLFdBQVcsRUFBRSxxQkFBcUIsQ0FBQyxDQUN6QyxDQUFBO0lBQ0QsTUFBTSxjQUFjLEdBQUcsRUFBRSxDQUFDLFVBQVUsQ0FDbEMsSUFBSSxDQUFDLE1BQUEsaUJBQWlCLEVBQUUsbUNBQUksV0FBVyxFQUFFLFdBQVcsQ0FBQyxDQUN0RCxDQUFBO0lBQ0QsbUdBQW1HO0lBQ25HLE1BQU0sY0FBYyxHQUFHLEVBQUUsQ0FBQyxVQUFVLENBQ2xDLElBQUksQ0FBQyxNQUFBLGlCQUFpQixFQUFFLG1DQUFJLFdBQVcsRUFBRSxXQUFXLENBQUMsQ0FDdEQsQ0FBQTtJQUNELElBQ0U7UUFDRSxpQkFBaUIsSUFBSSxnQkFBZ0I7UUFDckMsY0FBYztRQUNkLGNBQWM7S0FDZixDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUM1QixDQUFDO1FBQ0QsSUFBSSxzQkFBc0IsRUFBRSxDQUFDO1lBQzNCLE9BQU8sc0JBQXNCLENBQUE7UUFDL0IsQ0FBQztRQUNELElBQUksQ0FBQyxpQkFBaUIsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDNUMsbUdBQW1HO1lBQ25HLGdDQUFnQyxFQUFFLENBQUE7WUFDbEMsT0FBTyxNQUFNLENBQUE7UUFDZixDQUFDO1FBQ0QsNEJBQTRCLEVBQUUsQ0FBQTtRQUM5QixPQUFPLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFBO0lBQ3BELENBQUM7U0FBTSxJQUFJLGlCQUFpQixJQUFJLGdCQUFnQixFQUFFLENBQUM7UUFDakQsb0JBQW9CLENBQUMsc0JBQXNCLENBQUMsQ0FBQTtRQUM1QyxtQkFBbUIsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFBO1FBQzNDLE9BQU8sZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUE7SUFDcEQsQ0FBQztTQUFNLElBQUksY0FBYyxFQUFFLENBQUM7UUFDMUIsbUJBQW1CLENBQUMsc0JBQXNCLENBQUMsQ0FBQTtRQUMzQyxPQUFPLE1BQU0sQ0FBQTtJQUNmLENBQUM7U0FBTSxJQUFJLGNBQWMsRUFBRSxDQUFDO1FBQzFCLG9CQUFvQixDQUFDLHNCQUFzQixDQUFDLENBQUE7UUFDNUMsT0FBTyxLQUFLLENBQUE7SUFDZCxDQUFDO1NBQU0sQ0FBQztRQUNOLHFCQUFxQixFQUFFLENBQUE7UUFDdkIsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUNqQixDQUFDO0lBQ0QsTUFBTSxLQUFLLEVBQUUsQ0FBQTtBQUNmLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyBmcm9tIFwiZnMtZXh0cmFcIlxuaW1wb3J0IHsgam9pbiB9IGZyb20gXCIuL3BhdGguanNcIlxuaW1wb3J0IGNoYWxrIGZyb20gXCJjaGFsa1wiXG5pbXBvcnQgcHJvY2VzcyBmcm9tIFwicHJvY2Vzc1wiXG5pbXBvcnQgZmluZFdvcmtzcGFjZVJvb3QgZnJvbSBcImZpbmQteWFybi13b3Jrc3BhY2Utcm9vdFwiXG5cbmV4cG9ydCB0eXBlIFBhY2thZ2VNYW5hZ2VyID0gXCJ5YXJuXCIgfCBcIm5wbVwiIHwgXCJucG0tc2hyaW5rd3JhcFwiIHwgXCJidW5cIlxuXG5mdW5jdGlvbiBwcmludE5vWWFybkxvY2tmaWxlRXJyb3IoKSB7XG4gIGNvbnNvbGUubG9nKGBcbiR7Y2hhbGsucmVkLmJvbGQoXCIqKkVSUk9SKipcIil9ICR7Y2hhbGsucmVkKFxuICAgIGBUaGUgLS11c2UteWFybiBvcHRpb24gd2FzIHNwZWNpZmllZCBidXQgdGhlcmUgaXMgbm8geWFybi5sb2NrIGZpbGVgLFxuICApfVxuYClcbn1cblxuZnVuY3Rpb24gcHJpbnROb0J1bkxvY2tmaWxlRXJyb3IoKSB7XG4gIGNvbnNvbGUubG9nKGBcbiR7Y2hhbGsucmVkLmJvbGQoXCIqKkVSUk9SKipcIil9ICR7Y2hhbGsucmVkKFxuICAgIGBUaGUgLS11c2UtYnVuIG9wdGlvbiB3YXMgc3BlY2lmaWVkIGJ1dCB0aGVyZSBpcyBubyBidW4ubG9ja2IgZmlsZWAsXG4gICl9XG5gKVxufVxuXG5mdW5jdGlvbiBwcmludE5vTG9ja2ZpbGVzRXJyb3IoKSB7XG4gIGNvbnNvbGUubG9nKGBcbiR7Y2hhbGsucmVkLmJvbGQoXCIqKkVSUk9SKipcIil9ICR7Y2hhbGsucmVkKFxuICAgIGBObyBwYWNrYWdlLWxvY2suanNvbiwgbnBtLXNocmlua3dyYXAuanNvbiwgeWFybi5sb2NrLCBvciBidW4ubG9ja2IgZmlsZS5cblxuWW91IG11c3QgdXNlIGVpdGhlciBucG1APj01LCB5YXJuLCBucG0tc2hyaW5rd3JhcCwgb3IgYnVuIHRvIG1hbmFnZSB0aGlzIHByb2plY3Qnc1xuZGVwZW5kZW5jaWVzLmAsXG4gICl9XG5gKVxufVxuXG5mdW5jdGlvbiBwcmludFNlbGVjdGluZ0RlZmF1bHRNZXNzYWdlKCkge1xuICBjb25zb2xlLmluZm8oXG4gICAgYCR7Y2hhbGsuYm9sZChcbiAgICAgIFwicGF0Y2gtcGFja2FnZVwiLFxuICAgICl9OiB5b3UgaGF2ZSBtdWx0aXBsZSBsb2NrZmlsZXMsIGUuZy4geWFybi5sb2NrIGFuZCBwYWNrYWdlLWxvY2suanNvblxuRGVmYXVsdGluZyB0byB1c2luZyAke2NoYWxrLmJvbGQoXCJucG1cIil9XG5Zb3UgY2FuIG92ZXJyaWRlIHRoaXMgc2V0dGluZyBieSBwYXNzaW5nIC0tdXNlLXlhcm4sIC0tdXNlLWJ1biwgb3JcbmRlbGV0aW5nIHRoZSBjb25mbGljdGluZyBsb2NrZmlsZSBpZiB5b3UgZG9uJ3QgbmVlZCBpdFxuYCxcbiAgKVxufVxuXG5mdW5jdGlvbiBwcmludFNlbGVjdGluZ0RlZmF1bHRZYXJuTWVzc2FnZSgpIHtcbiAgY29uc29sZS5pbmZvKFxuICAgIGAke2NoYWxrLmJvbGQoXG4gICAgICBcInBhdGNoLXBhY2thZ2VcIixcbiAgICApfTogeW91IGhhdmUgYm90aCB5YXJuLmxvY2sgYW5kIGJ1bi5sb2NrYiBsb2NrZmlsZXNcbkRlZmF1bHRpbmcgdG8gdXNpbmcgJHtjaGFsay5ib2xkKFwieWFyblwiKX1cbllvdSBjYW4gb3ZlcnJpZGUgdGhpcyBzZXR0aW5nIGJ5IHBhc3NpbmcgLS11c2UtYnVuLCBvclxuZGVsZXRpbmcgeWFybi5sb2NrIGlmIHlvdSBkb24ndCBuZWVkIGl0XG5gLFxuICApXG59XG5cbmZ1bmN0aW9uIGNoZWNrRm9yWWFybk92ZXJyaWRlKG92ZXJyaWRlUGFja2FnZU1hbmFnZXI6IFBhY2thZ2VNYW5hZ2VyIHwgbnVsbCkge1xuICBpZiAob3ZlcnJpZGVQYWNrYWdlTWFuYWdlciA9PT0gXCJ5YXJuXCIpIHtcbiAgICBwcmludE5vWWFybkxvY2tmaWxlRXJyb3IoKVxuICAgIHByb2Nlc3MuZXhpdCgxKVxuICB9XG59XG5cbmZ1bmN0aW9uIGNoZWNrRm9yQnVuT3ZlcnJpZGUob3ZlcnJpZGVQYWNrYWdlTWFuYWdlcjogUGFja2FnZU1hbmFnZXIgfCBudWxsKSB7XG4gIGlmIChvdmVycmlkZVBhY2thZ2VNYW5hZ2VyID09PSBcImJ1blwiKSB7XG4gICAgcHJpbnROb0J1bkxvY2tmaWxlRXJyb3IoKVxuICAgIHByb2Nlc3MuZXhpdCgxKVxuICB9XG59XG5cbmV4cG9ydCBjb25zdCBkZXRlY3RQYWNrYWdlTWFuYWdlciA9IChcbiAgYXBwUm9vdFBhdGg6IHN0cmluZyxcbiAgb3ZlcnJpZGVQYWNrYWdlTWFuYWdlcjogUGFja2FnZU1hbmFnZXIgfCBudWxsLFxuKTogUGFja2FnZU1hbmFnZXIgPT4ge1xuICBjb25zdCBwYWNrYWdlTG9ja0V4aXN0cyA9IGZzLmV4aXN0c1N5bmMoXG4gICAgam9pbihhcHBSb290UGF0aCwgXCJwYWNrYWdlLWxvY2suanNvblwiKSxcbiAgKVxuICBjb25zdCBzaHJpbmtXcmFwRXhpc3RzID0gZnMuZXhpc3RzU3luYyhcbiAgICBqb2luKGFwcFJvb3RQYXRoLCBcIm5wbS1zaHJpbmt3cmFwLmpzb25cIiksXG4gIClcbiAgY29uc3QgeWFybkxvY2tFeGlzdHMgPSBmcy5leGlzdHNTeW5jKFxuICAgIGpvaW4oZmluZFdvcmtzcGFjZVJvb3QoKSA/PyBhcHBSb290UGF0aCwgXCJ5YXJuLmxvY2tcIiksXG4gIClcbiAgLy8gQnVuIHdvcmtzcGFjZXMgc2VlbSB0byB3b3JrIHRoZSBzYW1lIGFzIHlhcm4gd29ya3NwYWNlcyAtIGh0dHBzOi8vYnVuLnNoL2RvY3MvaW5zdGFsbC93b3Jrc3BhY2VzXG4gIGNvbnN0IGJ1bkxvY2tiRXhpc3RzID0gZnMuZXhpc3RzU3luYyhcbiAgICBqb2luKGZpbmRXb3Jrc3BhY2VSb290KCkgPz8gYXBwUm9vdFBhdGgsIFwiYnVuLmxvY2tiXCIpLFxuICApXG4gIGlmIChcbiAgICBbXG4gICAgICBwYWNrYWdlTG9ja0V4aXN0cyB8fCBzaHJpbmtXcmFwRXhpc3RzLFxuICAgICAgeWFybkxvY2tFeGlzdHMsXG4gICAgICBidW5Mb2NrYkV4aXN0cyxcbiAgICBdLmZpbHRlcihCb29sZWFuKS5sZW5ndGggPiAxXG4gICkge1xuICAgIGlmIChvdmVycmlkZVBhY2thZ2VNYW5hZ2VyKSB7XG4gICAgICByZXR1cm4gb3ZlcnJpZGVQYWNrYWdlTWFuYWdlclxuICAgIH1cbiAgICBpZiAoIXBhY2thZ2VMb2NrRXhpc3RzICYmICFzaHJpbmtXcmFwRXhpc3RzKSB7XG4gICAgICAvLyBUaGUgb25seSBjYXNlIHdoZXJlIHdlIGRvbid0IHdhbnQgdG8gZGVmYXVsdCB0byBucG0gaXMgd2hlbiB3ZSBoYXZlIGJvdGggeWFybiBhbmQgYnVuIGxvY2tmaWxlcy5cbiAgICAgIHByaW50U2VsZWN0aW5nRGVmYXVsdFlhcm5NZXNzYWdlKClcbiAgICAgIHJldHVybiBcInlhcm5cIlxuICAgIH1cbiAgICBwcmludFNlbGVjdGluZ0RlZmF1bHRNZXNzYWdlKClcbiAgICByZXR1cm4gc2hyaW5rV3JhcEV4aXN0cyA/IFwibnBtLXNocmlua3dyYXBcIiA6IFwibnBtXCJcbiAgfSBlbHNlIGlmIChwYWNrYWdlTG9ja0V4aXN0cyB8fCBzaHJpbmtXcmFwRXhpc3RzKSB7XG4gICAgY2hlY2tGb3JZYXJuT3ZlcnJpZGUob3ZlcnJpZGVQYWNrYWdlTWFuYWdlcilcbiAgICBjaGVja0ZvckJ1bk92ZXJyaWRlKG92ZXJyaWRlUGFja2FnZU1hbmFnZXIpXG4gICAgcmV0dXJuIHNocmlua1dyYXBFeGlzdHMgPyBcIm5wbS1zaHJpbmt3cmFwXCIgOiBcIm5wbVwiXG4gIH0gZWxzZSBpZiAoeWFybkxvY2tFeGlzdHMpIHtcbiAgICBjaGVja0ZvckJ1bk92ZXJyaWRlKG92ZXJyaWRlUGFja2FnZU1hbmFnZXIpXG4gICAgcmV0dXJuIFwieWFyblwiXG4gIH0gZWxzZSBpZiAoYnVuTG9ja2JFeGlzdHMpIHtcbiAgICBjaGVja0Zvcllhcm5PdmVycmlkZShvdmVycmlkZVBhY2thZ2VNYW5hZ2VyKVxuICAgIHJldHVybiBcImJ1blwiXG4gIH0gZWxzZSB7XG4gICAgcHJpbnROb0xvY2tmaWxlc0Vycm9yKClcbiAgICBwcm9jZXNzLmV4aXQoMSlcbiAgfVxuICB0aHJvdyBFcnJvcigpXG59XG4iXX0=